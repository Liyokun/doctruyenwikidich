<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AURA LIBRARY - VIRTUAL BROWSER</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; padding: 0; width: 100vw; height: 100vh; 
            background-color: #000; 
            background-size: cover; background-position: center; background-attachment: fixed;
            font-family: 'Segoe UI', sans-serif; color: #fff; overflow: hidden; 
        }
        
        #main-view { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; z-index: 1; }
        
        /* HEADER M·ªöI CH·ª®A 2 D√íNG */
        .header { 
            position: relative; 
            height: 75px; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            border-bottom: 1px solid rgba(255,255,255,0.2); 
            background: rgba(0,0,0,0.5); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
        }

        .header-title { font-size: 20px; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 3px; }
        
        /* CSS CH·ªÆ DUNG L∆Ø·ª¢NG */
        .storage-text {
            font-size: 11px;
            font-weight: bold;
            color: #fff;
            letter-spacing: 0.5px;
            transition: color 0.3s;
        }

        /* N√öT QUAY L·∫†I (TR√ÅI) */
        .back-to-index {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 28px;
            cursor: pointer;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .back-to-index:active { opacity: 0.5; transform: translateY(-50%) scale(0.9); }

        /* N√öT H∆Ø·ªöNG D·∫™N (PH·∫¢I) */
        .guide-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 26px;
            cursor: pointer;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .guide-btn:active { opacity: 0.5; transform: translateY(-50%) scale(0.9); }

        .list-container { flex: 1; overflow-y: auto; padding: 25px; padding-bottom: 100px; }
        
        .cat-card { 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.3); 
            padding: 25px; margin-bottom: 20px; border-radius: 12px; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; 
        }
        .cat-card:active { background: rgba(0,0,0,0.7); transform: scale(0.98); }
        .cat-info { flex: 1; } .delete-icon { font-size: 20px; color: #ff4444; padding: 10px; margin-right: -10px; transition: 0.2s; }
        
        #virtual-tab { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: transparent; background: rgba(0, 0, 0, 0.4); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            z-index: 999; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); }
        #virtual-tab.active { transform: translateX(0); }
        
        .tab-header { height: 70px; display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .back-btn { font-size: 28px; padding: 10px; cursor: pointer; margin-right: 15px; }
        
        .story-task { 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2); 
            margin-bottom: 20px; border-radius: 12px; overflow: hidden; transition: 0.3s; 
        }
        .story-header { padding: 25px; font-weight: bold; font-size: 18px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; gap: 10px; }
        .story-cover-thumb { width: 50px; height: 70px; object-fit: cover; border-radius: 4px; background: #222; margin-right: 15px; flex-shrink: 0; }
        .story-details { max-height: 0; overflow: hidden; background: rgba(0,0,0,0.4); transition: max-height 0.4s ease; padding: 0 25px; border-top: 1px solid rgba(255,255,255,0.05); }
        .story-task.expanded .story-details { max-height: 800px; padding-bottom: 25px; }
        
        .toggle-icon { display: inline-block; transition: transform 0.3s ease; }
        .story-task.expanded .toggle-icon { transform: rotate(180deg); }

        .scroll-container { display: flex; gap: 8px; margin-top: 8px; overflow-x: auto; white-space: nowrap; padding-bottom: 5px; scrollbar-width: none; }
        .tag-pill { background: #333; padding: 6px 12px; border-radius: 6px; font-size: 13px; color: #eee; flex-shrink: 0; }
        .btn-read { background: #fff; color: #000; padding: 12px 30px; border-radius: 30px; font-weight: bold; font-size: 15px; text-decoration: none; display: inline-block; box-shadow: 0 0 10px rgba(255,255,255,0.3); }
        .btn-delete { color: #ff4444; font-size: 14px; cursor: pointer; text-decoration: underline; padding: 10px; }
        
        .fab-btn { position: fixed; bottom: 40px; right: 30px; width: 70px; height: 70px; border-radius: 50%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); border: 2px solid #fff; color: #fff; font-size: 36px; display: flex; justify-content: center; align-items: center; z-index: 50; }
        
        /* Popup */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { width: 85%; max-width: 350px; background: #111; border: 1px solid #fff; border-radius: 15px; padding: 30px; text-align: center; }
        .modal-box.wide { max-width: 90%; width: 450px; }

        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="main-view">
        <div class="header">
            <div class="back-to-index" onclick="window.location.href='index.html'">&#8592;</div>
            <div class="header-title">TH∆Ø VI·ªÜN</div>
            <div class="storage-text" id="storage-text">D·ªØ li·ªáu c√≤n l·∫°i: ƒêang t√≠nh... / 1000 MB</div>
            <div class="guide-btn" onclick="openModal('modal-guide')">&#8594;</div>
        </div>
        <div id="category-list" class="list-container"></div>
        <div class="fab-btn" onclick="openModal('modal-add-cat')">+</div>
    </div>

    <div id="virtual-tab">
        <div class="tab-header">
            <div class="back-btn" onclick="closeVirtualTab()">&#8592;</div>
            <div class="header-title" id="tab-title">...</div>
        </div>
        <div id="story-list" class="list-container"></div>
        <div class="fab-btn" onclick="openModal('modal-add-story')">+</div>
    </div>

    <div id="modal-add-cat" class="modal-overlay">
        <div class="modal-box">
            <div style="margin-bottom:20px; font-weight:bold">CH·ª¶ ƒê·ªÄ</div>
            <input type="text" id="input-cat-name" style="width:100%; padding:15px; background:#000; border:1px solid #555; color:#fff; text-align:center; border-radius:8px; margin-bottom:20px" placeholder="Nh·∫≠p t√™n...">
            <div style="display:flex; gap:10px"><button onclick="closeModal('modal-add-cat')" style="flex:1; padding:12px; background:#333; color:#fff; border:none; border-radius:8px">H·ª¶Y</button><button onclick="handleAddCategory()" style="flex:1; padding:12px; background:#fff; color:#000; font-weight:bold; border:none; border-radius:8px">T·∫†O</button></div>
        </div>
    </div>

    <div id="modal-cat-options" class="modal-overlay">
        <div class="modal-box">
            <div style="margin-bottom:20px; font-weight:bold; font-size:18px;">T√ôY CH·ªåN CH·ª¶ ƒê·ªÄ</div>
            <div style="display:flex; flex-direction:column; gap:10px">
                <button onclick="openRenameModal()" style="padding:15px; background:#fff; color:#000; font-weight:bold; border:none; border-radius:8px; cursor:pointer;">ƒê·ªîI T√äN CH·ª¶ ƒê·ªÄ</button>
                <button onclick="openDeleteConfirm()" style="padding:15px; background:#ff4444; color:#fff; font-weight:bold; border:none; border-radius:8px; cursor:pointer;">X√ìA CH·ª¶ ƒê·ªÄ</button>
                <button onclick="closeModal('modal-cat-options')" style="padding:15px; background:#333; color:#fff; font-weight:bold; border:none; border-radius:8px; cursor:pointer; margin-top:10px;">H·ª¶Y B·ªé</button>
            </div>
        </div>
    </div>

    <div id="modal-rename-cat" class="modal-overlay">
        <div class="modal-box">
            <div style="margin-bottom:20px; font-weight:bold">ƒê·ªîI T√äN CH·ª¶ ƒê·ªÄ</div>
            <input type="text" id="input-rename-cat" style="width:100%; padding:15px; background:#000; border:1px solid #555; color:#fff; text-align:center; border-radius:8px; margin-bottom:20px" placeholder="Nh·∫≠p t√™n m·ªõi...">
            <div style="display:flex; gap:10px">
                <button onclick="closeModal('modal-rename-cat')" style="flex:1; padding:12px; background:#333; color:#fff; border:none; border-radius:8px">H·ª¶Y</button>
                <button onclick="handleRenameCategory()" style="flex:1; padding:12px; background:#fff; color:#000; font-weight:bold; border:none; border-radius:8px">L∆ØU</button>
            </div>
        </div>
    </div>

    <div id="modal-delete-cat" class="modal-overlay">
        <div class="modal-box">
            <div style="margin-bottom:15px; font-weight:bold; color:#ff4444; font-size:20px;">X√ÅC NH·∫¨N X√ìA</div>
            <div style="margin-bottom:25px; color:#ccc; font-size:14px; line-height:1.5;">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô ch·ªß ƒë·ªÅ n√†y c√πng t·∫•t c·∫£ truy·ªán b√™n trong kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</div>
            <div style="display:flex; gap:10px">
                <button onclick="closeModal('modal-delete-cat')" style="flex:1; padding:12px; background:#333; color:#fff; border:none; border-radius:8px; font-weight:bold;">H·ª¶Y</button>
                <button onclick="handleDeleteCategory()" style="flex:1; padding:12px; background:#ff4444; color:#fff; font-weight:bold; border:none; border-radius:8px;">X√ìA</button>
            </div>
        </div>
    </div>

    <div id="modal-add-story" class="modal-overlay">
        <div class="modal-box">
            <div style="margin-bottom:20px; font-weight:bold">B∆Ø·ªöC 1: LINK M·ª§C L·ª§C</div>
            <input type="text" id="input-story-url" style="width:100%; padding:15px; background:#000; border:1px solid #555; color:#fff; text-align:center; border-radius:8px; margin-bottom:20px" placeholder="D√°n link m·ª•c l·ª•c truy·ªán...">
            <div style="display:flex; gap:10px">
                <button onclick="closeModal('modal-add-story')" style="flex:1; padding:12px; background:#333; color:#fff; border:none; border-radius:8px">H·ª¶Y</button>
                <button onclick="openStepTwo()" style="flex:1; padding:12px; background:#fff; color:#000; font-weight:bold; border:none; border-radius:8px">TI·∫æP T·ª§C</button>
            </div>
        </div>
    </div>

    <div id="modal-add-chapters" class="modal-overlay">
        <div class="modal-box wide">
            <div style="margin-bottom:20px; font-weight:bold">B∆Ø·ªöC 2: D√ÅN DANH S√ÅCH CH∆Ø∆†NG</div>
            <textarea id="input-chapter-data" style="width:100%; height: 250px; padding:15px; background:#000; border:1px solid #555; color:#fff; border-radius:8px; margin-bottom:20px; white-space: pre; overflow-wrap: normal; overflow-x: auto;" placeholder="D√°n k·∫øt qu·∫£ t·ª´ Console v√†o ƒë√¢y...&#10;V√≠ d·ª•: [1] Ph·∫ßn 1 : https://..."></textarea>
            
            <div style="display:flex; gap:10px">
                <button onclick="closeModal('modal-add-chapters')" style="flex:1; padding:12px; background:#333; color:#fff; border:none; border-radius:8px">H·ª¶Y</button>
                <button onclick="handleFetchAndSaveStory()" style="flex:1; padding:12px; background:#fff; color:#000; font-weight:bold; border:none; border-radius:8px">L∆ØU & QU√âT TH√îNG TIN</button>
            </div>
        </div>
    </div>

    <div id="modal-loading" class="modal-overlay">
        <div class="modal-box"><div class="spinner"></div><div id="loading-text" style="font-weight:bold; letter-spacing: 1px;">ƒêANG K·∫æT N·ªêI...</div></div>
    </div>

    <div id="modal-guide" class="modal-overlay">
        <div class="modal-box wide">
            <div style="margin-bottom:15px; font-weight:bold; font-size:18px; color:#fff;">H∆Ø·ªöNG D·∫™N L·∫§Y TH√îNG TIN</div>
            <div style="font-size:13px; color:#ccc; line-height:1.6; text-align:left; margin-bottom:20px;">
                1. Nh·∫•p v√†o bi·ªÉu t∆∞·ª£ng <b>üìÉ</b> b√™n d∆∞·ªõi ƒë·ªÉ sao ch√©p l·ªánh d·ªØ li·ªáu v√†o b·ªô nh·ªõ t·∫°m.<br>
                2. M·ªü trang truy·ªán b·∫°n mu·ªën ƒë·ªçc.<br>
                3. B·∫≠t <b>C√¥ng c·ª• d√†nh cho nh√† ph√°t tri·ªÉn</b> (B·∫•m F12 tr√™n m√°y t√≠nh), chuy·ªÉn sang th·∫ª <b>Console</b>.<br>
                4. D√°n l·ªánh v·ª´a ch√©p v√†o Console v√† nh·∫•n Enter.<br>
                5. H·ªá th·ªëng s·∫Ω l·ªçc v√† t·ª± ƒë·ªông g·ª≠i d·ªØ li·ªáu c√°c ch∆∞∆°ng v√†o b·ªô nh·ªõ t·∫°m c·ªßa b·∫°n. H√£y quay l·∫°i web n√†y v√† d√°n v√†o b∆∞·ªõc th√™m danh s√°ch ch∆∞∆°ng.
            </div>
            
            <div style="margin-bottom:20px;">
                <button onclick="copyGuideSnippet()" style="padding:15px; background:#222; border:1px solid #555; border-radius:8px; color:#fff; font-size:35px; cursor:pointer; width:100%; transition:0.2s;" id="btn-copy-snippet">üìÉ</button>
                <div style="font-size:11px; color:#888; margin-top:5px;">Nh·∫•p v√†o bi·ªÉu t∆∞·ª£ng tr√™n ƒë·ªÉ sao ch√©p l·ªánh</div>
            </div>

            <button onclick="closeModal('modal-guide')" style="width:100%; padding:15px; background:#fff; color:#000; font-weight:bold; border:none; border-radius:8px; cursor:pointer;">OK</button>
        </div>
    </div>
    <div id="modal-confirm-story-delete" class="modal-overlay">
    <div class="modal-box">
        <div style="margin-bottom:15px; font-weight:bold; color:#ff4444; font-size:20px;">X√ìA TRUY·ªÜN?</div>
        <div style="margin-bottom:25px; color:#ccc; font-size:14px; line-height:1.5;">H√†nh ƒë·ªông n√†y s·∫Ω x√≥a s·∫°ch <b>to√†n b·ªô d·ªØ li·ªáu ch∆∞∆°ng</b> ƒë√£ t·∫£i offline c·ªßa truy·ªán n√†y. B·∫°n ch·∫Øc ch·∫Øn ch·ª©?</div>
        <div style="display:flex; gap:10px">
            <button onclick="closeModal('modal-confirm-story-delete')" style="flex:1; padding:12px; background:#333; color:#fff; border:none; border-radius:8px; font-weight:bold;">H·ª¶Y</button>
            <button onclick="executeDeleteStory()" style="flex:1; padding:12px; background:#ff4444; color:#fff; font-weight:bold; border:none; border-radius:8px;">X√ìA S·∫†CH</button>
        </div>
    </div>
</div>

    <script>
        const PROXY_HOST = "https://doctruyen01.nguyenphuoctu6554.workers.dev/?url=";
        let libraryData = [];
        let currentCatID = null;
        let temporaryStoryUrl = "";
        let actionCatID = null; 
        let storyIDToDelete = null; // L∆∞u ID truy·ªán ƒëang ch·ªù x√°c nh·∫≠n x√≥a

        // H√ÄM T√çNH TO√ÅN DUNG L∆Ø·ª¢NG (D√ôNG INDEXEDDB)
        async function updateStorageIndicator() {
            let totalBytes = 0;
            try {
                // V√≤ng l·∫∑p duy·ªát qua to√†n b·ªô "Kho h√†ng" IndexedDB
                await localforage.iterate(function(value, key) {
                    let valStr = typeof value === 'string' ? value : JSON.stringify(value);
                    totalBytes += (key.length + (valStr ? valStr.length : 0)) * 2; // JavaScript d√πng UTF-16 (2 bytes/k√≠ t·ª±)
                });
            } catch(e) { console.warn("L·ªói t√≠nh dung l∆∞·ª£ng: ", e); }
            
            let totalMB = totalBytes / (1024 * 1024);
            
            // ƒê·∫∑t m·ªëc 1000 MB
            let remaining = 1000 - totalMB;
            if (remaining < 0) remaining = 0;
            
            const numEl = document.getElementById('storage-text');
            if (numEl) {
                numEl.innerText = `D·ªØ li·ªáu c√≤n l·∫°i: ${remaining.toFixed(2)} / 1000 MB`;
                // N·∫øu d∆∞·ªõi 500 MB th√¨ c·∫£nh b√°o ƒë·ªè
                if (remaining < 500) {
                    numEl.style.color = '#ff4444'; 
                } else {
                    numEl.style.color = '#fff';
                }
            }
        }

        // N√ÇNG C·∫§P L√äN ASYNC CHO INDEXEDDB
        window.onload = async function() {
            // L·∫•y d·ªØ li·ªáu th∆∞ vi·ªán t·ª´ IndexedDB thay v√¨ localStorage
            libraryData = await localforage.getItem('aura_library_v2') || [];
            
            // L·∫•y n·ªÅn ƒë√£ ch·ªçn (H·ªó tr·ª£ l·∫•y t·ª´ localforage ho·∫∑c fallback localStorage n·∫øu ch∆∞a k·ªãp chuy·ªÉn)
            let currentBgIndex = await localforage.getItem('aura_bg_index') || localStorage.getItem('aura_bg_index') || 1;
            document.body.style.backgroundImage = `url('./book0${currentBgIndex}.jpg')`;
            
            renderCategories();
            updateStorageIndicator(); // C·∫≠p nh·∫≠t dung l∆∞·ª£ng 1000 MB
        };

        function renderCategories() {
            const container = document.getElementById('category-list'); container.innerHTML = '';
            if (libraryData.length === 0) { container.innerHTML = '<div style="text-align:center; color:#ddd; margin-top:80px; text-shadow: 0 2px 4px rgba(0,0,0,0.8);">Nh·∫•n + ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>'; return; }
            libraryData.forEach(cat => {
                const card = document.createElement('div'); card.className = 'cat-card';
                card.innerHTML = `<div class="cat-info" onclick="openVirtualTab('${cat.id}')"><span>${cat.name} <span style="opacity:0.5; font-size:14px">(${cat.stories.length})</span></span></div><span class="delete-icon" onclick="openCatOptions('${cat.id}')">üìù</span>`;
                container.appendChild(card);
            });
        }

        function openCatOptions(id) { actionCatID = id; openModal('modal-cat-options'); }
        function openRenameModal() { closeModal('modal-cat-options'); const cat = libraryData.find(c => c.id === actionCatID); document.getElementById('input-rename-cat').value = cat ? cat.name : ''; openModal('modal-rename-cat'); }

        async function handleRenameCategory() {
            const newName = document.getElementById('input-rename-cat').value.trim();
            if (newName && actionCatID) {
                const cat = libraryData.find(c => c.id === actionCatID);
                if(cat) cat.name = newName;
                await saveData();
                renderCategories();
            }
            closeModal('modal-rename-cat');
        }

        function openDeleteConfirm() { closeModal('modal-cat-options'); openModal('modal-delete-cat'); }

        async function handleDeleteCategory() {
    if (actionCatID) {
        // 1. T√¨m ch·ªß ƒë·ªÅ s·∫Øp b·ªã x√≥a ƒë·ªÉ l·∫•y danh s√°ch truy·ªán b√™n trong
        const catToDelete = libraryData.find(c => c.id === actionCatID);
        
        if (catToDelete && catToDelete.stories.length > 0) {
            // 2. Thu th·∫≠p t·∫•t c·∫£ ID truy·ªán trong ch·ªß ƒë·ªÅ n√†y
            const storyIDs = catToDelete.stories.map(s => s.id);
            
            // 3. Qu√©t to√†n b·ªô kho IndexedDB ƒë·ªÉ x√≥a d·ªØ li·ªáu ch∆∞∆°ng (_CH_)
            // Ch√∫ng ta d√πng iterate ƒë·ªÉ duy·ªát m·ªôt l·∫ßn cho s·∫°ch
            await localforage.iterate(function(value, key) {
                // Ki·ªÉm tra xem key n√†y c√≥ thu·ªôc v·ªÅ b·∫•t k·ª≥ truy·ªán n√†o trong danh s√°ch x√≥a kh√¥ng
                const belongsToDeletedStory = storyIDs.some(id => key.startsWith(id + '_CH_'));
                
                if (belongsToDeletedStory) {
                    localforage.removeItem(key); // X√≥a lu√¥n ru·ªôt truy·ªán
                }
            });
        }

        // 4. X√≥a c√°i "v·ªè" ch·ªß ƒë·ªÅ kh·ªèi danh s√°ch qu·∫£n l√Ω
        libraryData = libraryData.filter(c => c.id !== actionCatID);
        
        await saveData(); 
        renderCategories();
        alert("ƒê√£ x√≥a s·∫°ch ch·ªß ƒë·ªÅ v√† to√†n b·ªô n·ªôi dung truy·ªán li√™n quan!");
    }
    closeModal('modal-delete-cat');
}
        async function handleAddCategory() {
            const name = document.getElementById('input-cat-name').value.trim();
            if (name) { libraryData.push({ id: 'CAT_' + Date.now(), name, stories: [] }); await saveData(); renderCategories(); }
            closeModal('modal-add-cat'); document.getElementById('input-cat-name').value = '';
        }

        function openVirtualTab(id) {
            currentCatID = id; const cat = libraryData.find(c => c.id === id);
            document.getElementById('tab-title').innerText = cat.name;
            renderStories(cat); document.getElementById('virtual-tab').classList.add('active');
        }

        function closeVirtualTab() { document.getElementById('virtual-tab').classList.remove('active'); renderCategories(); }

        function renderStories(cat) {
            const container = document.getElementById('story-list'); container.innerHTML = '';
            cat.stories.forEach(s => {
                const task = document.createElement('div'); task.className = 'story-task';
                task.innerHTML = `<div class="story-header" onclick="this.parentElement.classList.toggle('expanded')"><img src="${s.cover}" class="story-cover-thumb" onerror="this.style.display='none'"><span>${s.title}</span><span class="toggle-icon">‚ñº</span></div><div class="story-details"><p style="font-size:14px;color:#ccc">T√°c gi·∫£: ${s.author}</p><div class="scroll-container">${s.tags.map(t=>`<span class="tag-pill">${t}</span>`).join('')}</div><div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center"><span onclick="deleteStory('${s.id}')" style="color:#ff4444; font-size:13px; cursor:pointer; font-weight:bold;">X√≥a truy·ªán</span><a href="library02.html?id=${s.id}" class="btn-read">ƒê·ªåC NGAY</a></div></div>`;
                container.appendChild(task);
            });
        }

        function openStepTwo() {
            const url = document.getElementById('input-story-url').value.trim();
            if (!url) { alert("Vui l√≤ng nh·∫≠p link m·ª•c l·ª•c truy·ªán!"); return; }
            temporaryStoryUrl = url; 
            closeModal('modal-add-story'); openModal('modal-add-chapters');
        }

        function parseManualChapters(rawText) {
            const lines = rawText.trim().split('\n');
            const chapters = [];
            for (let line of lines) {
                const splitIndex = line.lastIndexOf(' : ');
                if (splitIndex !== -1) {
                    let name = line.substring(0, splitIndex).trim();
                    let url = line.substring(splitIndex + 3).trim();
                    name = name.replace(/^\[\d+\]\s*/, '');
                    if (name && url) chapters.push({ name: name, url: url });
                }
            }
            return chapters;
        }

        async function handleFetchAndSaveStory() {
            const rawChapterData = document.getElementById('input-chapter-data').value.trim();
            if (!rawChapterData) { alert("Vui l√≤ng d√°n danh s√°ch ch∆∞∆°ng!"); return; }

            const chaptersList = parseManualChapters(rawChapterData);
            if (chaptersList.length === 0) { alert("Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c c·∫•u tr√∫c ch∆∞∆°ng! H√£y ch·∫Øc ch·∫Øn b·∫°n d√°n ƒë√∫ng k·∫øt qu·∫£ t·ª´ l·ªánh Console."); return; }

            closeModal('modal-add-chapters');
            openModal('modal-loading');
            
            const url = temporaryStoryUrl;
            let baseUrl = "";
            try { baseUrl = new URL(url).origin; } catch(e) { baseUrl = ""; }

            try {
                updateLoadingText("ƒêANG QU√âT SI√äU D·ªÆ LI·ªÜU...");
                const res = await fetch(PROXY_HOST + encodeURIComponent(url));
                let htmlText = await res.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, "text/html");

                const title = doc.querySelector(".cover-info h2")?.textContent.trim() || doc.title || "Ch∆∞a r√µ t√™n";
                const author = doc.querySelector(".book-info a[href*='tac-gia']")?.textContent.trim() || "Ch∆∞a r√µ";
                let cover = doc.querySelector(".cover-wrapper img")?.getAttribute("src") || "";
                if(cover && cover.startsWith("/")) cover = baseUrl + cover;
                const tags = Array.from(doc.querySelectorAll(".book-desc a")).map(el => el.textContent.trim());

                const cat = libraryData.find(c => c.id === currentCatID);
                cat.stories.push({ id: 'STR_' + Date.now(), title: title, author: author, cover: cover, tags: tags, url: temporaryStoryUrl, chapters: chaptersList, lastReadIndex: 0 });
                
                await saveData(); 
                renderStories(cat); 
                closeModal('modal-loading');
                
                document.getElementById('input-story-url').value = '';
                document.getElementById('input-chapter-data').value = '';
                temporaryStoryUrl = "";

            } catch (err) { closeModal('modal-loading'); alert("L·ªói khi k·∫øt n·ªëi l·∫•y th√¥ng tin truy·ªán: " + err.message); }
        }

        // L∆ØU D·ªÆ LI·ªÜU V√ÄO INDEXEDDB
        async function saveData() { 
            await localforage.setItem('aura_library_v2', libraryData); 
            updateStorageIndicator();
        }
        
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function updateLoadingText(t) { document.getElementById('loading-text').innerText = t; }
        
        // H√†m n√†y ch·ªâ ƒë·ªÉ m·ªü b·∫£ng h·ªèi
function deleteStory(id) {
    storyIDToDelete = id;
    openModal('modal-confirm-story-delete');
}

// H√†m n√†y m·ªõi th·ª±c s·ª± l√†m nhi·ªám v·ª• x√≥a khi b·∫°n b·∫•m n√∫t "X√ìA S·∫†CH" tr√™n Modal
async function executeDeleteStory() {
    const id = storyIDToDelete;
    if (!id) return;

    closeModal('modal-confirm-story-delete');
    updateLoadingText("ƒêANG QU√âT & X√ìA D·ªÆ LI·ªÜU...");
    openModal('modal-loading');

    try {
        const cat = libraryData.find(c => c.id === currentCatID);
        if (cat) {
            // 1. X√≥a d·ªØ li·ªáu "ru·ªôt" trong IndexedDB
            await localforage.iterate(function(value, key) {
                if (key.startsWith(id + '_CH_')) {
                    localforage.removeItem(key);
                }
            });

            // 2. X√≥a c√°i "v·ªè" truy·ªán
            cat.stories = cat.stories.filter(s => s.id !== id);
            
            // 3. L∆∞u l·∫°i (C√≥ await ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n)
            await saveData(); 
            renderStories(cat);
            
            closeModal('modal-loading');
            // C·∫≠p nh·∫≠t l·∫°i dung l∆∞·ª£ng hi·ªÉn th·ªã tr√™n Header
            await updateStorageIndicator(); 
        }
    } catch (e) {
        closeModal('modal-loading');
        alert("L·ªói khi x√≥a: " + e.message);
    }
    storyIDToDelete = null;
}

        // ==========================================
        // ƒêO·∫†N M√É COPY SNIPPET L√âN NG·∫¶M V√ÄO CLIPBOARD
        // ==========================================
        function copyGuideSnippet() {
            const btn = document.getElementById('btn-copy-snippet');
            btn.style.transform = "scale(0.9)";
            setTimeout(() => btn.style.transform = "scale(1)", 200);

            // B·ªçc l·ªánh trong d·∫•u backtick (` `), s·ª≠ d·ª•ng d·∫•u (\\) k√©p ƒë·ªÉ b·∫£o v·ªá c√∫ ph√°p Regex kh√¥ng b·ªã g√£y khi copy
            const snippet = `(function() {
    var finalList = [];
    var seenLinks = {};
    var seenTitles = {};
    var count = 0;
    
    var allLinks = document.querySelectorAll('a');

    allLinks.forEach(function(a) {
        var title = a.innerText.replace(/\\s+/g, ' ').trim();
        var link = a.href;

        var isRealChapter = /\\/(chuong|trang|phan)-|(\\/[A-Za-z0-9]{10,})$/.test(link);

        if (title.length > 0 && link.includes('/truyen/') && isRealChapter && !link.includes('#')) {
            if (!seenLinks[link] && !seenTitles[title]) {
                seenLinks[link] = true;
                seenTitles[title] = true;
                count++;
                finalList.push("[" + count + "] " + title + " : " + link);
            }
        }
    });

    if (count === 0) {
        allLinks.forEach(function(a) {
            var title = a.innerText.replace(/\\s+/g, ' ').trim();
            var link = a.href;
            if (title.length > 0 && link.includes('/truyen/') && link.split('/').length > 5 && !link.includes('#')) {
                if (!seenLinks[link] && !seenTitles[title]) {
                    seenLinks[link] = true;
                    seenTitles[title] = true;
                    count++;
                    finalList.push("[" + count + "] " + title + " : " + link);
                }
            }
        });
    }

    var output = (finalList.length > 0) ? finalList.join('\\n') : "V·∫´n kh√¥ng th·∫•y! H√£y th·ª≠ cu·ªôn trang xu·ªëng d∆∞·ªõi c√πng r·ªìi ch·∫°y l·∫°i l·ªánh.";

    try {
        copy(String(output)); 
    } catch (e) {
        var temp = document.createElement("textarea");
        temp.value = output;
        document.body.appendChild(temp);
        temp.select();
        document.execCommand("copy");
        document.body.removeChild(temp);
    }
    
    alert("H·ªá th·ªëng ƒë√£ d·ªçn s·∫°ch tr√πng l·∫∑p v√† CH√âP V√ÄO KHAY NH·ªö T·∫†M!\\nT·ªïng c·ªông: " + count + " k·∫øt qu·∫£ duy nh·∫•t.");
})();`;

            // K·ªπ thu·∫≠t t·∫°o textarea ·∫£o ƒë·ªÉ copy (T∆∞∆°ng th√≠ch t·ªët tr√™n c·∫£ Mobile)
            const tempInput = document.createElement("textarea");
            tempInput.value = snippet;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);

            // Hi·ªáu ·ª©ng ph·∫£n h·ªìi th√†nh c√¥ng
            btn.innerText = "‚úîÔ∏è ƒê√É SAO CH√âP L·ªÜNH";
            btn.style.background = "#2ecc71";
            btn.style.color = "#000";
            
            setTimeout(() => {
                btn.innerText = "üìÉ";
                btn.style.background = "#222";
                btn.style.color = "#fff";
            }, 3000);
        }
    </script>
</body>
</html>
